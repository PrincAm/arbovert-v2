# htaccess rules for subdomains and aliases
# to create new subdomain, create a folder www/subdom/(subdomain name)
# to create web for alias, create a folder www/domains/(whole domain name)

# htaccess pravidla pro subdomeny a samostatne weby aliasu
# pro vytvoreni subdomeny vytvorte adresar www/subdom/(nazev subdomeny)
# pro vytvoreni webu pro alias vytvorte adresar www/domains/(cely domenovy nazev)
# dalsi info a priklady: https://kb.wedos.com/cs/webhosting/htaccess/htaccess-na-webhostingu

RewriteEngine On

# Disable automatic trailing slash addition for directories
# This prevents redirect loops when directories have corresponding .html files
# Note: Some servers may not support this directive
DirectorySlash Off

# 1) www.arbovert.cz → arbovert.cz (na jakékoli schéma)
RewriteCond %{HTTP_HOST} ^www\.arbovert\.cz$ [NC]
RewriteRule ^ https://arbovert.cz%{REQUEST_URI} [L,R=301]

# 2) http://arbovert.cz → https://arbovert.cz
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP_HOST} ^arbovert\.cz$ [NC]
RewriteRule ^ https://arbovert.cz%{REQUEST_URI} [L,R=301]

# Redirect old inventarizace-drevin URL to new location
RewriteRule ^inventarizace-drevin/?$ /sluzby/inventarizace-drevin [L,R=301]

# Redirect .html URLs to clean URLs (301 permanent redirect for SEO)
# This must come BEFORE the rewrite rule that serves .html files
# Only process external requests, not internal rewrites (prevents loops)
RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond %{REQUEST_URI} \.html$
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^(.+)\.html$ /$1 [R=301,L]

# Redirect trailing slash to clean URL (if corresponding .html file exists)
# This prevents directory listing and redirect loops
RewriteCond %{REQUEST_URI} ^(.+)/$
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{DOCUMENT_ROOT}/$1.html -f
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Handle clean URLs - rewrite to .html file for Next.js static export
# Priority: If a .html file exists for a path, serve it instead of directory
# This handles the case where both /sluzby (directory) and /sluzby.html exist
# Only process if URI doesn't already end in .html and is not root
RewriteCond %{REQUEST_URI} !\.html$
RewriteCond %{REQUEST_URI} !^/$
# Check that the .html file actually exists
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.html -f
# Don't rewrite if the requested path is already a file
RewriteCond %{REQUEST_FILENAME} !-f
# Don't rewrite if this is already an internal redirect (prevents loops)
RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteRule ^(.*)$ $1.html [L]

# cele domeny (aliasy)
# Skip for main domain - only apply to aliases
RewriteCond %{HTTP_HOST} !^arbovert\.cz$ [NC]
RewriteCond %{HTTP_HOST} !^www\.arbovert\.cz$ [NC]
RewriteCond %{REQUEST_URI} !^domains/
RewriteCond %{REQUEST_URI} !^/domains/
RewriteCond %{HTTP_HOST} ^(www\.)?(.*)$
RewriteCond %{DOCUMENT_ROOT}/domains/%2 -d
RewriteRule (.*) domains/%2/$1 [DPI]

# subdomeny (s nebo bez www na zacatku)
# Skip for main domain - only apply to subdomains
RewriteCond %{HTTP_HOST} !^arbovert\.cz$ [NC]
RewriteCond %{HTTP_HOST} !^www\.arbovert\.cz$ [NC]
RewriteCond %{REQUEST_URI} !^subdom/
RewriteCond %{REQUEST_URI} !^/subdom/
RewriteCond %{HTTP_HOST} ^(www\.)?(.*)\.([^\.]*)\.([^\.]*)$
RewriteCond %{DOCUMENT_ROOT}/subdom/%2 -d
RewriteRule (.*) subdom/%2/$1 [DPI]

# aliasy - spravne presmerovani pri chybejicim /
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^domains/[^/]+/(.+[^/])$ /$1/ [R]

# subdomeny - spravne presmerovani pri chybejicim /
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^subdom/[^/]+/(.+[^/])$ /$1/ [R]
